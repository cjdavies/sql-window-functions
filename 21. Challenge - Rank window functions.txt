Challenge - Rank window functions

As I promised, I believe you will find this challenge more difficult than the previous warm up one. Naturally, it will involve rank window functions. It may also require aggregate window functions, or even group aggregate functions just to make thing more interesting. This challenge is an example of a common category of challenges that I frequently encounter in the real world, analyzing time series data, for example stock prices or sensor readings over time. I recommend that you use a similar approach to the one I demonstrated with a previous solution. Break down your solution into small, digestible chunks using as many CTEs as you feel comfortable with. After each one, execute a select star, preferably by an order by to keep row order consistent for visual reference, and once you're happy with it, proceed to the next step. Remember that data type issues can hinder your progress, so make sure to cast expressions early to manageable easy to read types. Enjoy.